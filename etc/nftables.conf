#!/usr/sbin/nft -f

# Purge existing ruleset to ensure a clean state
flush ruleset

table inet filter {

    # --- INBOUND TRAFFIC POLICY ---
    chain input {
        # Default policy: DROP. Implement "Silent Drop" for stealth and security.
        type filter hook input priority 0; policy drop;

        # 1. Stateful Inspection: Accept traffic associated with established sessions.
        # Necessary for return traffic from outbound requests.
        ct state established,related accept

        # 2. Loopback Interface: Permit all traffic on 'lo' for inter-process communication.
        iifname "lo" accept

        # 3. Sanity Check: Drop packets with 'invalid' connection state (anti-reconnaissance).
        ct state invalid drop

        # 4. ICMPv4 Control Plane: Permit 'destination-unreachable' only.
        # Required for Path MTU Discovery (PMTUD) to prevent fragmentation issues.
        # Stealth: System remains unresponsive to Echo Request (ping) and TTL Exceeded (traceroute).
        ip protocol icmp icmp type destination-unreachable accept

        # 5. ICMPv6 Neighbor Discovery: Essential for IPv6 stack functionality.
        # Security: Enforce Hop Limit 255 to ensure packets originate from the local link only (GTSM).
        ip6 nexthdr icmpv6 ip6 hoplimit 255 icmpv6 type { nd-neighbor-solicit, nd-neighbor-advert, nd-router-advert } accept

        # 6. Remote Management (Optional): Uncomment for SSH access.
        # tcp dport 22 accept
    }

    # --- FORWARDING POLICY ---
    chain forward {
        # Host is not a router. Drop all transit traffic.
        type filter hook forward priority 0; policy drop;
    }

    # --- OUTBOUND TRAFFIC POLICY ---
    chain output {
        # Permit all outbound traffic for system and user applications.
        type filter hook output priority 0; policy accept;
    }
}
